# DÃ©finition des diffÃ©rentes Ã©tapes du pipeline
stages:
  - build              # Ã‰tape de compilation du projet
  - test               # Ã‰tape des tests unitaires et d'intÃ©gration
  - selenium           # Ã‰tape des tests Selenium
  - package            # Ã‰tape de crÃ©ation de l'artefact final
  - docker             # Ã‰tape de crÃ©ation et push de l'image Docker
  - deploy             # Ã‰tape de dÃ©ploiement sur Kubernetes

# Cache Maven pour Ã©viter de retÃ©lÃ©charger les dÃ©pendances Ã  chaque exÃ©cution
cache:
  key:
    files:
      - pom.xml  # Utilisation du fichier pom.xml comme clÃ© de cache
  paths:
    - .m2/repository/  # Cache du rÃ©pertoire local Maven
  policy: pull-push

# DÃ©finition des variables d'environnement utilisÃ©es dans le pipeline
variables:
  IMAGE_NAME: "registry.gitlab.com/groupe-devops3/gestion-etablissement"  # Nom de l'image Docker
  REGISTRY_DEV: "elhadji01/dev-registry"  # Registry de dÃ©veloppement
  REGISTRY_PROD: "elhadji01/prod-registry"  # Registry de production

# Ã‰tape de prÃ©paration avant l'exÃ©cution des scripts
before_script:
  - export TAG=${CI_COMMIT_REF_NAME}  # DÃ©finir le tag Ã  partir de la branche actuelle

# ğŸ”¹ Ã‰tape 1 : Compilation du projet
build:
  stage: build
  image: maven:3.8.6-eclipse-temurin-17  # Image Maven avec OpenJDK 17
  script:
    - mvn clean package -DskipTests  # Nettoyage du projet et compilation sans les tests
  artifacts:
    paths:
      - target/*.jar  # Conserver le fichier JAR gÃ©nÃ©rÃ©

# ğŸ”¹ Ã‰tape 2 : Tests unitaires et d'intÃ©gration
test:
  stage: test
  image: maven:3.8.6-eclipse-temurin-17  # Image Maven avec OpenJDK 17
  services:
    - name: mysql:8.0  # Service MySQL pour les tests d'intÃ©gration
      alias: mysql  # Alias MySQL pour la connexion
  variables:
    MYSQL_DATABASE: gestion_etablissement
    MYSQL_ROOT_PASSWORD: root
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/gestion_etablissement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    SPRING_DATASOURCE_USERNAME: root
    SPRING_DATASOURCE_PASSWORD: root
  before_script:
    - apt-get update && apt-get install -y mysql-client  # Installer mysql-client pour interagir avec MySQL
    - until mysql -h mysql -P 3306 -uroot -proot -e "select 1"; do echo "Waiting for MySQL to be available..."; sleep 5; done  # Attendre que MySQL soit disponible
  script:
    - mvn test  # ExÃ©cution des tests unitaires et d'intÃ©gration

# ğŸ”¹ Ã‰tape 3 : Tests Selenium
selenium-tests:
  stage: selenium  # Nouvelle Ã©tape dÃ©diÃ©e aux tests Selenium
  image: "maven:3.8.6-eclipse-temurin-17"  # Image Maven avec OpenJDK 17
  services:
    - name: mysql:8.0  # Service MySQL pour les tests Selenium
      alias: mysql  # Alias MySQL pour la connexion
    - name: selenium/standalone-chrome  # Utilisation de Selenium avec le navigateur Chrome
      alias: selenium  # Alias Selenium
  variables:
    MYSQL_DATABASE: gestion_etablissement
    MYSQL_ROOT_PASSWORD: root
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/gestion_etablissement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    SPRING_DATASOURCE_USERNAME: root
    SPRING_DATASOURCE_PASSWORD: root
  before_script:
    - apt-get update && apt-get install -y mysql-client  # Installer mysql-client pour interagir avec MySQL
    - until mysql -h mysql -P 3306 -uroot -proot -e "select 1"; do echo "Waiting for MySQL to be available..."; sleep 5; done  # Attendre que MySQL soit disponible
  script:
    - echo "DÃ©marrage de l'application en arriÃ¨re-plan..."  # DÃ©marrer l'application pour les tests Selenium
    - mvn spring-boot:run &  # Lancer l'application en arriÃ¨re-plan
    - sleep 10  # Attendre que l'application dÃ©marre
    - echo "ExÃ©cution des tests Selenium..."  # Lancer les tests Selenium
    - mvn test -Dtest=isi.devops.gestion_etablissement.selenium.ClasseTest  # ExÃ©cuter les tests Selenium
  only:
    - main  # ExÃ©cuter cette Ã©tape seulement sur la branche principale

# ğŸ”¹ Ã‰tape 4 : CrÃ©ation de l'artefact final
package:
  stage: package
  image: maven:3.8.6-eclipse-temurin-17  # Image Maven avec OpenJDK 17
  services:
    - name: mysql:8.0  # Service MySQL pour la crÃ©ation du package
      alias: mysql  # Alias MySQL pour la connexion
  variables:
    MYSQL_DATABASE: gestion_etablissement
    MYSQL_ROOT_PASSWORD: root
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/gestion_etablissement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    SPRING_DATASOURCE_USERNAME: root
    SPRING_DATASOURCE_PASSWORD: root
  before_script:
    - apt-get update && apt-get install -y mysql-client  # Installer mysql-client pour interagir avec MySQL
    - until mysql -h mysql -P 3306 -uroot -proot -e "select 1"; do echo "Waiting for MySQL to be available..."; sleep 5; done  # Attendre que MySQL soit disponible
  script:
    - mvn package  # CrÃ©ation du package final (JAR ou autre artefact)

# ğŸ”¹ Ã‰tape 5 : CrÃ©ation et push de l'image Docker
docker:
  stage: docker
  image: docker:latest  # Utiliser Docker pour la crÃ©ation et le push de l'image
  services:
    - docker:dind  # Service Docker-in-Docker
  script:
    - echo "Connexion Ã  GitLab Container Registry..."  # Connexion au registre Docker de GitLab
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - export IMAGE_TAG="$IMAGE_NAME:$TAG"  # DÃ©finir le tag de l'image
    - echo "CrÃ©ation de l'image Docker avec le tag : $IMAGE_TAG"
    - docker build -t "$IMAGE_TAG" .  # CrÃ©er l'image Docker
    - docker push "$IMAGE_TAG"  # Push de l'image vers le registre Docker

# ğŸ”¹ Ã‰tape 6 : DÃ©ploiement sur Kubernetes
deploy:
  stage: deploy
  image: ubuntu:latest  # Utilisation d'une image Ubuntu pour dÃ©ployer sur Kubernetes
  variables:
    IMAGE_NAME: "$IMAGE_NAME:$TAG"  # Nom de l'image Docker avec tag
  before_script:
    - apt-get update && apt-get install -y curl python3-venv python3-pip  # Installer curl et outils Python
    - python3 -m venv venv  # CrÃ©er un environnement virtuel
    - source venv/bin/activate  # Activer l'environnement virtuel
    - pip install awscli  # Installer AWS CLI
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"  # TÃ©lÃ©charger kubectl
    - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl  # Installer kubectl
  script:
    - echo "ğŸ”‘ Configurer AWS CLI"
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID  # Configurer AWS CLI
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set region eu-north-1
    - echo "ğŸ”‘ Mettre Ã  jour le contexte Kubernetes pour EKS"
    - aws eks update-kubeconfig --name gestion-etablissement-cluster --region eu-north-1  # Mettre Ã  jour kubeconfig
    - kubectl config current-context  # VÃ©rifier le contexte Kubernetes actuel
#    - echo "ğŸ”‘ Configurer l'accÃ¨s Ã  Kubernetes"
#    - echo "$KUBECONFIG" | base64 --decode > kubeconfig.yaml
#    - cat kubeconfig.yaml  # Afficher le contenu du fichier kubeconfig.yaml
#    - export KUBECONFIG=kubeconfig.yaml
#    - kubectl config get-contexts  # Lister tous les contextes disponibles
#    - kubectl config use-context arn:aws:eks:eu-north-1:851725523231:cluster/gestion-etablissement-cluster
#    - echo "ğŸ” VÃ©rifier la connexion au cluster EKS"
#    - kubectl get nodes
#    - echo "ğŸš€ DÃ©ployer sur Kubernetes (Preprod)"
#    - kubectl apply -f k8s/namespace.yaml
#    - kubectl apply -f k8s/deployment.yaml
#    - kubectl apply -f k8s/service.yaml